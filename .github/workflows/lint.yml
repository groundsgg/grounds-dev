name: Lint and Check

on:
  pull_request: {}
  push:
    branches: [ main ]

jobs:
  lint:
    name: ğŸ” Lint Shell Scripts and YAML
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Prerequisites
        run: |
          echo "ğŸ”§ Installing all prerequisites in one step..."

          # Update package lists
          sudo apt-get update

          # Install system packages
          sudo apt-get install -y shellcheck python3-pip

          # Install Python packages
          pip3 install yamllint

          # Install Helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

          # Install k3d
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install helmfile
          curl -L https://github.com/helmfile/helmfile/releases/download/v0.156.0/helmfile_0.156.0_linux_amd64.tar.gz | tar xz
          sudo mv helmfile /usr/local/bin/

          echo "âœ… All prerequisites installed successfully"

      - name: ğŸš Lint Shell Scripts
        run: |
          echo "ğŸ” Linting shell scripts..."
          find . -name "*.sh" -type f -exec shellcheck {} + || {
            echo "âŒ Shell script linting failed"
            exit 1
          }
          echo "âœ… All shell scripts passed linting"

      - name: ğŸ“„ Lint YAML Files
        run: |
          echo "ğŸ” Linting YAML files..."
          yamllint . || {
            echo "âŒ YAML linting failed"
            exit 1
          }
          echo "âœ… All YAML files passed linting"

      - name: âš™ï¸ Validate k3d Configuration
        run: |
          echo "ğŸ” Validating k3d configuration..."
          k3d cluster create test-cluster --config cluster/k3d.yaml --dry-run || {
            echo "âŒ k3d configuration validation failed"
            exit 1
          }
          echo "âœ… k3d configuration is valid"

      - name: ğŸ“¦ Validate Helm Charts
        run: |
          echo "ğŸ” Validating Helm charts..."
          helmfile lint || {
            echo "âŒ Helm chart validation failed"
            exit 1
          }
          echo "âœ… All Helm charts are valid"

      - name: â˜¸ï¸ Validate Kubernetes Manifests
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          kubectl apply --dry-run=client -f manifests/ || {
            echo "âŒ Kubernetes manifest validation failed"
            exit 1
          }
          echo "âœ… All Kubernetes manifests are valid"
